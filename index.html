<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пиццерия You Печка | Доставка и самовывоз</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { orange: '#C68663', dark: '#1C1917', light: '#FDFBF7' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        body { background-color: #FDFBF7; }
        .no-scroll { overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
    </style>
</head>
<body class="text-stone-800 antialiased selection:bg-orange-200">

    <!-- Header -->
    <header id="navbar" class="fixed top-0 w-full z-40 transition-all duration-300 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-3 group">
                <img src="logo.jpg" alt="You Печка" onerror="this.src='https://placehold.co/100x100/C68663/FFF?text=YP'" class="w-12 h-12 sm:w-14 sm:h-14 rounded-full object-cover border-2 border-stone-800 shadow-sm transition-transform group-hover:scale-105">
                <div class="flex flex-col">
                    <span class="font-serif italic text-2xl sm:text-3xl text-stone-800 leading-none -mb-1">You</span>
                    <span class="font-black text-xl sm:text-2xl tracking-widest text-stone-800 leading-none uppercase">ПЕЧКА</span>
                </div>
            </a>
            <nav class="hidden md:flex items-center space-x-8 font-medium text-stone-600">
                <a href="#menu" class="hover:text-orange-600 transition-colors">Меню</a>
                <a href="#contacts" class="hover:text-orange-600 transition-colors">Контакты</a>
            </nav>
            <div class="flex items-center space-x-4">
                <a href="tel:+79297252455" id="header-phone" class="hidden sm:flex items-center font-bold text-stone-700 hover:text-orange-600 transition-colors">
                    8 (929) 725-24-55
                </a>
                <button onclick="toggleCart()" class="relative flex items-center justify-center w-12 h-12 rounded-full bg-stone-900 text-white hover:bg-orange-600 transition-colors shadow-lg">
                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                    <span id="cart-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-orange-500 text-white text-xs font-bold rounded-full flex items-center justify-center border-2 border-white">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Hero -->
    <section class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden">
        <div class="absolute inset-0 z-0">
            <div class="absolute inset-0 bg-gradient-to-r from-[#FDFBF7] via-[#FDFBF7]/80 to-transparent z-10"></div>
            <img src="https://images.unsplash.com/photo-1590947132387-155cc02f3212?w=1600&q=80" alt="Pizza" class="w-full h-full object-cover opacity-90">
        </div>
        <div class="relative z-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="max-w-2xl">
                <div class="inline-flex items-center bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full text-stone-800 font-bold text-sm mb-6 shadow-sm border border-stone-200">
                    <i data-lucide="flame" class="w-4 h-4 text-orange-500 mr-2"></i>
                    Готовим с любовью
                </div>
                <h1 class="text-5xl md:text-7xl font-black text-stone-900 leading-tight mb-6">
                    Горячая пицца <br/><span class="text-orange-600">прямо из печи</span>
                </h1>
                <p class="text-xl text-stone-600 mb-8 max-w-lg">
                    Оформляйте заказ прямо на сайте. Самовывоз или доставка — выбирайте, как вам удобнее!
                </p>
                <a href="#menu" class="inline-flex items-center justify-center px-8 py-4 bg-stone-900 text-white font-bold rounded-full hover:bg-orange-600 transition-all shadow-xl hover:-translate-y-1">
                    Выбрать пиццу
                </a>
            </div>
        </div>
    </section>

    <!-- Menu -->
    <section id="menu" class="py-20 bg-[#FDFBF7]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-black text-stone-900 mb-4 uppercase tracking-tight">Наше Меню</h2>
                <div class="w-24 h-1.5 bg-orange-500 mx-auto rounded-full"></div>
            </div>
            <div id="menu-container" class="space-y-16"></div>
        </div>
    </section>

    <!-- Contacts & Map -->
    <section id="contacts" class="py-20 bg-stone-900 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                <div>
                    <h2 class="text-3xl font-black mb-8 uppercase">Ждем вас в гости</h2>
                    <div class="space-y-6">
                        <div class="flex items-start">
                            <div class="w-12 h-12 rounded-2xl bg-stone-800 flex items-center justify-center flex-shrink-0 mr-4">
                                <i data-lucide="map-pin" class="w-6 h-6 text-orange-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg">Адрес</h4>
                                <p id="contact-address" class="text-stone-400">с. Усады, ул. Ярышлар, 2Б</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="w-12 h-12 rounded-2xl bg-stone-800 flex items-center justify-center flex-shrink-0 mr-4">
                                <i data-lucide="clock" class="w-6 h-6 text-orange-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg">Режим работы</h4>
                                <p id="contact-hours" class="text-stone-400">Ежедневно 10:00 – 21:00</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-[400px] w-full bg-stone-200 rounded-3xl overflow-hidden relative border border-stone-700 shadow-lg">
                    <iframe
                        src="https://yandex.ru/map-widget/v1/?ll=49.199541%2C55.680483&z=17&pt=49.199541,55.680483,pm2rdm"
                        width="100%" height="100%" frameborder="0" allowfullscreen="true"></iframe>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-stone-950 text-stone-500 py-8 text-center text-sm">
        &copy; <span id="year"></span> You ПЕЧКА. Все права защищены.
    </footer>

    <!-- Cart Sidebar -->
    <div id="cart-overlay" onclick="toggleCart()" class="fixed inset-0 z-[60] bg-stone-900/60 backdrop-blur-sm hidden transition-opacity opacity-0"></div>
    <div id="cart-sidebar" class="fixed inset-y-0 right-0 z-[61] w-full max-w-md bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-6 border-b border-stone-100 flex items-center justify-between bg-stone-50">
            <h2 class="text-xl font-black flex items-center"><i data-lucide="shopping-bag" class="w-5 h-5 mr-2"></i>Корзина</h2>
            <button onclick="toggleCart()" class="p-2 hover:bg-stone-200 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div id="cart-items" class="flex-grow overflow-y-auto p-6 space-y-6"></div>
        <div id="cart-footer" class="hidden p-6 border-t border-stone-100 bg-stone-50">
            <!-- Promo code -->
            <div class="mb-4">
                <div class="flex gap-2">
                    <input type="text" id="promo-input" placeholder="Промокод" class="flex-1 px-3 py-2 border border-stone-200 rounded-xl outline-none text-sm uppercase font-mono focus:ring-2 focus:ring-orange-500">
                    <button onclick="applyPromo()" class="bg-stone-800 hover:bg-stone-700 text-white px-4 py-2 rounded-xl text-sm font-medium transition-colors">Применить</button>
                </div>
                <p id="promo-status" class="text-xs mt-1.5 hidden"></p>
            </div>
            <div id="cart-summary" class="space-y-1 mb-4">
                <div class="flex justify-between items-center">
                    <span class="text-stone-500 font-medium">Итого:</span>
                    <span id="cart-total" class="text-2xl font-black text-stone-900">0 ₽</span>
                </div>
            </div>
            <button onclick="openCheckoutModal()" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-4 rounded-xl shadow-lg transition-colors flex justify-center items-center">
                Перейти к оформлению
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 z-[70] bg-stone-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl flex flex-col overflow-hidden max-h-[90vh]">
            <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                <h3 class="text-xl font-bold text-stone-800">Оформление заказа</h3>
                <button onclick="closeCheckoutModal()" class="text-stone-400 hover:text-stone-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form onsubmit="submitOrder(event)" class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Ваше имя</label>
                    <input type="text" id="order-name" required class="w-full px-4 py-3 border border-stone-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Иван">
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Телефон</label>
                    <input type="tel" id="order-phone" required class="w-full px-4 py-3 border border-stone-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none" placeholder="+7 (999) 000-00-00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Способ получения</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="setDeliveryType('pickup')" id="dt-pickup" class="flex items-center justify-center px-4 py-3 border-2 border-stone-900 bg-stone-900 text-white rounded-xl font-medium text-sm transition-colors">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>Самовывоз
                        </button>
                        <button type="button" onclick="setDeliveryType('delivery')" id="dt-delivery" class="flex items-center justify-center px-4 py-3 border-2 border-stone-200 bg-white text-stone-600 rounded-xl font-medium text-sm transition-colors hidden">
                            <i data-lucide="truck" class="w-4 h-4 mr-2"></i>Доставка
                        </button>
                    </div>
                    <p id="pickup-info" class="text-xs text-stone-500 mt-2 flex items-center"><i data-lucide="map-pin" class="w-3 h-3 mr-1 text-orange-500"></i><span id="pickup-addr-text">ул. Ярышлар, 2Б</span></p>
                </div>
                <!-- Delivery address (shown when delivery selected) -->
                <div id="delivery-address-block" class="hidden">
                    <label class="block text-sm font-medium text-stone-700 mb-1">Адрес доставки</label>
                    <input type="text" id="order-address" class="w-full px-4 py-3 border border-stone-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Улица, дом, квартира">
                    <div id="delivery-zone-info" class="text-xs text-stone-500 mt-1"></div>
                </div>
                <!-- Order summary -->
                <div id="checkout-summary" class="bg-stone-50 rounded-xl p-4 border border-stone-100 space-y-2 text-sm"></div>
                <button id="submit-btn" type="submit" class="w-full mt-2 bg-stone-900 hover:bg-stone-800 text-white font-bold py-4 rounded-xl flex items-center justify-center transition-colors">
                    <i data-lucide="send" class="w-5 h-5 mr-2"></i> Отправить заказ
                </button>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 z-[80] bg-stone-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl p-8 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check" class="w-8 h-8 text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-stone-800 mb-2">Заказ принят!</h3>
            <p id="success-order-number" class="text-stone-500 mb-6">Мы уже начали готовить вашу пиццу. Скоро свяжемся с вами.</p>
            <button onclick="closeSuccessModal()" class="w-full bg-stone-900 text-white font-bold py-3 rounded-xl">Отлично</button>
        </div>
    </div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
const API = 'api';
let menuItems = [];
let cart = [];
let isCartOpen = false;
let deliveryConfig = { delivery_enabled: false, pickup_address: '', min_order_amount: 0, zones: [] };
let selectedDeliveryType = 'pickup';
let appliedPromo = null;

// ============================================================
// API HELPER
// ============================================================
async function apiFetch(endpoint) {
    const res = await fetch(`${API}/${endpoint}`);
    if (!res.ok) throw new Error('Ошибка сервера');
    return res.json();
}

async function apiPost(endpoint, body) {
    const res = await fetch(`${API}/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ошибка сервера');
    return data;
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
    lucide.createIcons();
    document.getElementById('year').textContent = new Date().getFullYear();

    // Load menu from API
    try {
        const data = await apiFetch('menu.php');
        menuItems = [];
        (data.categories || []).forEach(cat => {
            (cat.items || []).forEach(item => {
                item.category = cat.name;
                menuItems.push(item);
            });
        });
        renderMenu();
    } catch(e) {
        console.error('Failed to load menu from API, using fallback', e);
        menuItems = getFallbackMenu();
        renderMenu();
    }

    // Load delivery config
    try {
        deliveryConfig = await apiFetch('delivery.php');
        if (deliveryConfig.pickup_address) {
            document.getElementById('pickup-addr-text').textContent = deliveryConfig.pickup_address;
        }
        // Show delivery button if enabled
        if (deliveryConfig.delivery_enabled) {
            document.getElementById('dt-delivery').classList.remove('hidden');
        }
    } catch(e) { console.error('Delivery config error:', e); }

    // Load settings for contacts
    try {
        // We can't access admin settings API without auth, so we use delivery config
    } catch(e) {}
});

// ============================================================
// RENDER MENU
// ============================================================
function renderMenu() {
    const container = document.getElementById('menu-container');
    container.innerHTML = '';
    const categories = [...new Set(menuItems.map(i => i.category))];

    categories.forEach(cat => {
        const items = menuItems.filter(i => i.category === cat);
        let html = `<div class="mb-12"><h3 class="text-2xl font-bold mb-6 flex items-center"><span class="w-3 h-8 bg-orange-500 rounded-full mr-4"></span>${cat}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">`;

        items.forEach(item => {
            let tagsHtml = '';
            const tags = item.tags || [];
            tags.forEach(tag => {
                if (tag.trim()) tagsHtml += `<span class="bg-white/90 backdrop-blur text-stone-800 text-xs font-bold px-3 py-1 rounded-full shadow-sm">${tag}</span>`;
            });

            const defImg = 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=500&q=80';
            const imgUrl = item.image || item.img || defImg;

            html += `
                <div class="bg-white rounded-3xl p-4 shadow-sm hover:shadow-xl transition-all border border-stone-100 flex flex-col">
                    <div class="relative h-56 mb-4 overflow-hidden rounded-2xl bg-stone-100">
                        <img src="${imgUrl}" onerror="this.src='${defImg}'" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-500">
                        <div class="absolute top-3 right-3 flex flex-col gap-2">${tagsHtml}</div>
                    </div>
                    <div class="flex justify-between items-start mb-2 gap-2">
                        <h4 class="text-xl font-bold">${item.name}</h4>
                        <span class="text-lg font-black text-orange-600 whitespace-nowrap">${item.price} ₽</span>
                    </div>
                    <p class="text-stone-500 text-sm mb-4 flex-grow">${item.description || item.desc || ''}</p>
                    <div class="pt-4 border-t border-stone-50 flex items-center justify-between">
                        <span class="text-xs font-medium text-stone-400 uppercase">${item.size || ''}</span>
                        <button onclick="addToCart(${item.id})" class="w-10 h-10 rounded-full bg-stone-100 hover:bg-stone-900 hover:text-white flex items-center justify-center transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>`;
        });
        html += `</div></div>`;
        container.innerHTML += html;
    });
    lucide.createIcons();
}

// ============================================================
// CART
// ============================================================
function toggleCart() {
    const overlay = document.getElementById('cart-overlay');
    const sidebar = document.getElementById('cart-sidebar');
    isCartOpen = !isCartOpen;

    if (isCartOpen) {
        document.body.classList.add('no-scroll');
        overlay.classList.remove('hidden');
        setTimeout(() => { overlay.classList.remove('opacity-0'); sidebar.classList.remove('translate-x-full'); }, 10);
    } else {
        document.body.classList.remove('no-scroll');
        overlay.classList.add('opacity-0'); sidebar.classList.add('translate-x-full');
        setTimeout(() => { overlay.classList.add('hidden'); }, 300);
    }
}

function addToCart(id) {
    const item = menuItems.find(i => i.id === id);
    if (!item) return;
    const existing = cart.find(i => i.id === id);
    if (existing) existing.qty++; else cart.push({ ...item, qty: 1 });
    updateCartUI();
    if (!isCartOpen) toggleCart();
}

function updateQty(id, delta) {
    const item = cart.find(i => i.id === id);
    if (!item) return;
    item.qty += delta;
    if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
    updateCartUI();
}

function updateCartUI() {
    const container = document.getElementById('cart-items');
    const footer = document.getElementById('cart-footer');
    const badge = document.getElementById('cart-badge');

    const count = cart.reduce((sum, i) => sum + i.qty, 0);
    const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);

    badge.textContent = count;
    badge.classList.toggle('hidden', count === 0);

    // Calculate discount
    let discount = 0;
    if (appliedPromo) {
        if (appliedPromo.discount_type === 'percent') {
            discount = Math.round(subtotal * appliedPromo.discount_value / 100);
        } else {
            discount = Math.min(appliedPromo.discount_value, subtotal);
        }
    }
    const total = subtotal - discount;

    // Summary
    let summaryHtml = `<div class="flex justify-between items-center">
        <span class="text-stone-500 font-medium text-sm">Подытог:</span>
        <span class="font-bold text-stone-700">${subtotal} ₽</span>
    </div>`;
    if (discount > 0) {
        summaryHtml += `<div class="flex justify-between items-center text-green-600">
            <span class="text-sm font-medium">Скидка (${appliedPromo.code}):</span>
            <span class="font-bold">-${discount} ₽</span>
        </div>`;
    }
    summaryHtml += `<div class="flex justify-between items-center pt-1 border-t border-stone-200">
        <span class="text-stone-500 font-medium">Итого:</span>
        <span class="text-2xl font-black text-stone-900">${total} ₽</span>
    </div>`;
    document.getElementById('cart-summary').innerHTML = summaryHtml;

    if (count === 0) {
        footer.classList.add('hidden');
        container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-stone-400"><i data-lucide="shopping-bag" class="w-16 h-16 opacity-20 mb-4"></i><p>Корзина пуста</p></div>`;
        appliedPromo = null;
        document.getElementById('promo-status').classList.add('hidden');
    } else {
        footer.classList.remove('hidden');
        container.innerHTML = cart.map(item => {
            const imgUrl = item.image || item.img || 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=500';
            return `
            <div class="flex gap-4">
                <img src="${imgUrl}" class="w-16 h-16 rounded-xl object-cover border border-stone-100">
                <div class="flex-grow">
                    <div class="flex justify-between"><h4 class="font-bold">${item.name}</h4><span class="font-bold">${item.price * item.qty}₽</span></div>
                    <div class="flex items-center mt-2 space-x-3">
                        <button onclick="updateQty(${item.id}, -1)" class="w-6 h-6 bg-stone-100 rounded-full flex items-center justify-center hover:bg-stone-200 transition-colors">-</button>
                        <span class="font-bold text-sm">${item.qty}</span>
                        <button onclick="updateQty(${item.id}, 1)" class="w-6 h-6 bg-stone-100 rounded-full flex items-center justify-center hover:bg-stone-200 transition-colors">+</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }
    lucide.createIcons();
}

// ============================================================
// PROMO CODES
// ============================================================
async function applyPromo() {
    const code = document.getElementById('promo-input').value.trim();
    const status = document.getElementById('promo-status');
    if (!code) return;

    try {
        const data = await apiFetch('promos.php?code=' + encodeURIComponent(code));
        const promo = data.promo;
        const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);

        if (promo.min_order > 0 && subtotal < promo.min_order) {
            status.textContent = `Минимальная сумма заказа: ${promo.min_order} ₽`;
            status.className = 'text-xs mt-1.5 text-red-500';
            status.classList.remove('hidden');
            appliedPromo = null;
            updateCartUI();
            return;
        }

        appliedPromo = promo;
        const discText = promo.discount_type === 'percent' ? promo.discount_value + '%' : promo.discount_value + ' ₽';
        status.textContent = `Промокод применен! Скидка: ${discText}`;
        status.className = 'text-xs mt-1.5 text-green-600 font-medium';
        status.classList.remove('hidden');
        updateCartUI();
    } catch(e) {
        status.textContent = 'Промокод не найден или недействителен';
        status.className = 'text-xs mt-1.5 text-red-500';
        status.classList.remove('hidden');
        appliedPromo = null;
        updateCartUI();
    }
}

// ============================================================
// CHECKOUT
// ============================================================
function setDeliveryType(type) {
    selectedDeliveryType = type;
    const pickupBtn = document.getElementById('dt-pickup');
    const deliveryBtn = document.getElementById('dt-delivery');
    const addrBlock = document.getElementById('delivery-address-block');
    const pickupInfo = document.getElementById('pickup-info');
    const addrInput = document.getElementById('order-address');

    if (type === 'pickup') {
        pickupBtn.className = 'flex items-center justify-center px-4 py-3 border-2 border-stone-900 bg-stone-900 text-white rounded-xl font-medium text-sm transition-colors';
        deliveryBtn.className = 'flex items-center justify-center px-4 py-3 border-2 border-stone-200 bg-white text-stone-600 rounded-xl font-medium text-sm transition-colors';
        addrBlock.classList.add('hidden');
        pickupInfo.classList.remove('hidden');
        addrInput.removeAttribute('required');
    } else {
        deliveryBtn.className = 'flex items-center justify-center px-4 py-3 border-2 border-stone-900 bg-stone-900 text-white rounded-xl font-medium text-sm transition-colors';
        pickupBtn.className = 'flex items-center justify-center px-4 py-3 border-2 border-stone-200 bg-white text-stone-600 rounded-xl font-medium text-sm transition-colors';
        addrBlock.classList.remove('hidden');
        pickupInfo.classList.add('hidden');
        addrInput.setAttribute('required', 'required');

        // Show delivery zones info
        const zones = deliveryConfig.zones || [];
        if (zones.length > 0) {
            document.getElementById('delivery-zone-info').innerHTML = zones.map(z =>
                `<span class="inline-block bg-stone-100 px-2 py-1 rounded-md mr-1 mb-1">${z.name}: ${z.delivery_fee} ₽</span>`
            ).join('');
        }
    }
    updateCheckoutSummary();
    lucide.createIcons();
}

function openCheckoutModal() {
    toggleCart();
    document.getElementById('checkout-modal').classList.remove('hidden');
    selectedDeliveryType = 'pickup';
    setDeliveryType('pickup');
    updateCheckoutSummary();
    lucide.createIcons();
}

function closeCheckoutModal() {
    document.getElementById('checkout-modal').classList.add('hidden');
}

function updateCheckoutSummary() {
    const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
    let discount = 0;
    if (appliedPromo) {
        if (appliedPromo.discount_type === 'percent') discount = Math.round(subtotal * appliedPromo.discount_value / 100);
        else discount = Math.min(appliedPromo.discount_value, subtotal);
    }
    // Delivery fee (use cheapest zone as estimate)
    let deliveryFee = 0;
    if (selectedDeliveryType === 'delivery') {
        const zones = deliveryConfig.zones || [];
        if (zones.length > 0) deliveryFee = Math.min(...zones.map(z => parseFloat(z.delivery_fee)));
    }
    const total = subtotal - discount + deliveryFee;

    let html = '';
    cart.forEach(i => {
        html += `<div class="flex justify-between"><span class="text-stone-600">${i.qty}x ${i.name}</span><span class="font-medium">${i.price * i.qty} ₽</span></div>`;
    });
    if (discount > 0) {
        html += `<div class="flex justify-between text-green-600"><span>Скидка (${appliedPromo.code})</span><span>-${discount} ₽</span></div>`;
    }
    if (deliveryFee > 0) {
        html += `<div class="flex justify-between text-stone-500"><span>Доставка (от)</span><span>+${deliveryFee} ₽</span></div>`;
    }
    html += `<div class="flex justify-between pt-2 border-t border-stone-200 font-bold text-lg"><span>Итого</span><span class="text-orange-600">${total} ₽</span></div>`;

    document.getElementById('checkout-summary').innerHTML = html;
}

async function submitOrder(e) {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Отправка...`;
    lucide.createIcons();

    const orderData = {
        customer_name: document.getElementById('order-name').value,
        customer_phone: document.getElementById('order-phone').value,
        delivery_type: selectedDeliveryType,
        items: cart.map(i => ({ menu_item_id: i.id, quantity: i.qty }))
    };

    if (selectedDeliveryType === 'delivery') {
        orderData.delivery_address = document.getElementById('order-address').value;
    }
    if (appliedPromo) {
        orderData.promo_code = appliedPromo.code;
    }

    try {
        const result = await apiPost('orders.php', orderData);
        closeCheckoutModal();
        cart = [];
        appliedPromo = null;
        updateCartUI();
        document.getElementById('promo-input').value = '';
        document.getElementById('promo-status').classList.add('hidden');

        const orderNum = result.order_number || '';
        document.getElementById('success-order-number').innerHTML = orderNum
            ? `Заказ <b>#${orderNum}</b> принят! Мы уже начали готовить вашу пиццу.`
            : 'Мы уже начали готовить вашу пиццу. Скоро свяжемся с вами.';
        document.getElementById('success-modal').classList.remove('hidden');
        lucide.createIcons();
    } catch(error) {
        alert('Ошибка: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<i data-lucide="send" class="w-5 h-5 mr-2"></i> Отправить заказ`;
        lucide.createIcons();
    }
}

function closeSuccessModal() {
    document.getElementById('success-modal').classList.add('hidden');
}

// ============================================================
// FALLBACK MENU (if API is unavailable)
// ============================================================
function getFallbackMenu() {
    return [
        { id: 1, category: 'Пицца', name: 'Пепперони', price: 550, size: '30 см', description: 'Тонкое тесто, сливочный/томатный соус, сыр моцарелла, пепперони', tags: [], image: 'https://images.unsplash.com/photo-1628840042765-356cda07504e?w=500&q=80' },
        { id: 2, category: 'Пицца', name: 'Мясная', price: 650, size: '30 см', description: 'Тонкое тесто, томатный соус, сыр моцарелла, ветчина, пепперони, куриная грудка, охотничьи колбаски, маслины', tags: ['Много мяса!'], image: 'https://images.unsplash.com/photo-1604381538336-254bc79a9f49?w=500&q=80' },
        { id: 3, category: 'Пицца', name: 'Курица грибы', price: 550, size: '30 см', description: 'Тонкое тесто, томатный соус, сыр моцарелла, куриное филе, шампиньоны', tags: [], image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=500&q=80' },
        { id: 4, category: 'Пицца', name: 'С креветками', price: 600, size: '30 см', description: 'Тонкое тесто, сливочный соус, сыр моцарелла, королевские креветки, томаты, базилик', tags: [], image: 'https://images.unsplash.com/photo-1516697073-419b2bd079db?w=500&q=80' },
        { id: 5, category: 'Пицца', name: 'Маргарита', price: 500, size: '30 см', description: 'Тонкое тесто, томатный соус, сыр моцарелла, томаты, базилик', tags: [], image: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=500&q=80' },
        { id: 101, category: 'Дополни пиццу', name: 'Сыр', price: 50, size: 'Добавка', description: '', tags: [], image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?w=500&q=80' },
        { id: 102, category: 'Дополни пиццу', name: 'Овощи / грибы', price: 30, size: 'Добавка', description: '', tags: [], image: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?w=500&q=80' },
        { id: 103, category: 'Дополни пиццу', name: 'Мясо / колбаса', price: 50, size: 'Добавка', description: '', tags: [], image: 'https://images.unsplash.com/photo-1615937657715-bc7b4b7962c1?w=500&q=80' }
    ];
}
</script>
</body>
</html>
